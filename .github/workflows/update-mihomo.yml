name: Update Mihomo

on:
  schedule:
    # æ¯å¤© åŒ—äº¬æ—¶é—´ 8:30 å®šæ—¶æ‰§è¡Œï¼ˆUTC 00:30ï¼‰
    - cron: '30 0 * * *'
  workflow_dispatch:
    # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  actions: write

concurrency:
  group: update-mihomo
  cancel-in-progress: false

jobs:
  update:
    name: Check and Update Mihomo
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      MAKEFILE_PATH: nikki/Makefile
      UPSTREAM_REPO: MetaCubeX/mihomo
      GH_TOKEN: ${{ github.token }}
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine versions
        id: meta
        run: |
          set -euo pipefail

          makefile="${MAKEFILE_PATH}"

          pkg_name="$(awk -F':=' '/^[[:space:]]*PKG_NAME:=/{print $2; exit}' "${makefile}" | tr -d ' \t\r\n')"
          current_version="$(awk -F':=' '/^[[:space:]]*PKG_SOURCE_VERSION:=/{print $2; exit}' "${makefile}" | tr -d ' \t\r\n')"

          if [ -z "${pkg_name}" ] || [ -z "${current_version}" ]; then
            echo "æ— æ³•ä» ${makefile} è¯»å– PKG_NAME æˆ– PKG_SOURCE_VERSION"
            exit 1
          fi

          echo "pkg_name=${pkg_name}" >> "${GITHUB_OUTPUT}"
          echo "current_version=${current_version}" >> "${GITHUB_OUTPUT}"
          echo "å½“å‰ç‰ˆæœ¬: ${current_version}"

          release_url="https://api.github.com/repos/${UPSTREAM_REPO}/releases/latest"
          echo "è·å–ä¸Šæ¸¸ release: ${release_url}"

          max_retries=3
          retry_delay=10
          release_info=""
          latest_version=""
          published_at=""

          for attempt in $(seq 1 "${max_retries}"); do
            echo "ç¬¬ ${attempt}/${max_retries} æ¬¡å°è¯•è·å– release ä¿¡æ¯..."

            if release_info="$(curl -fsSL -H "Authorization: Bearer ${GH_TOKEN}" "${release_url}" 2>/dev/null)"; then
              latest_version="$(echo "${release_info}" | jq -r '.tag_name // empty' 2>/dev/null || true)"
              published_at="$(echo "${release_info}" | jq -r '.published_at // empty' 2>/dev/null || true)"
              if [ -n "${latest_version}" ] && [ -n "${published_at}" ]; then
                break
              fi
            fi

            release_info=""
            latest_version=""
            published_at=""

            if [ "${attempt}" -lt "${max_retries}" ]; then
              echo "è·å–å¤±è´¥ï¼Œ${retry_delay} ç§’åé‡è¯•..."
              sleep "${retry_delay}"
            fi
          done

          if [ -z "${latest_version}" ] || [ -z "${published_at}" ]; then
            echo "skip=true" >> "${GITHUB_OUTPUT}"
            echo "need_update=false" >> "${GITHUB_OUTPUT}"
            echo "æ— æ³•è·å–ä¸Šæ¸¸ç‰ˆæœ¬ä¿¡æ¯ï¼Œè·³è¿‡æœ¬æ¬¡æ›´æ–°"
            if [ -n "${release_info}" ]; then
              echo "API è¿”å›å†…å®¹:"
              echo "${release_info}" | jq '.' 2>/dev/null || echo "${release_info}"
            fi
            exit 0
          fi

          pkg_version="$(date -d "${published_at}" +%Y.%m.%d)"

          echo "skip=false" >> "${GITHUB_OUTPUT}"
          echo "latest_version=${latest_version}" >> "${GITHUB_OUTPUT}"
          echo "pkg_version=${pkg_version}" >> "${GITHUB_OUTPUT}"
          echo "published_at=${published_at}" >> "${GITHUB_OUTPUT}"
          echo "ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬: ${latest_version}"
          echo "å‘å¸ƒæ—¥æœŸ: ${pkg_version}"

          if [ "${current_version}" = "${latest_version}" ]; then
            echo "need_update=false" >> "${GITHUB_OUTPUT}"
            echo "ç‰ˆæœ¬ç›¸åŒï¼Œæ— éœ€æ›´æ–°"
          else
            echo "need_update=true" >> "${GITHUB_OUTPUT}"
            echo "å‘ç°æ–°ç‰ˆæœ¬ï¼Œéœ€è¦æ›´æ–°"
          fi

      - name: Calculate new hash (OpenWrt compatible)
        if: steps.meta.outputs.need_update == 'true'
        id: hash
        run: |
          set -euo pipefail

          version="${{ steps.meta.outputs.latest_version }}"
          pkg_name="${{ steps.meta.outputs.pkg_name }}"
          pkg_version="${{ steps.meta.outputs.pkg_version }}"
          subdir="${pkg_name}-${pkg_version}"

          echo "å¼€å§‹è®¡ç®— hash..."
          echo "VERSION: ${version}"
          echo "PKG_VERSION: ${pkg_version}"
          echo "SUBDIR: ${subdir}"

          work_dir="$(mktemp -d)"
          cleanup() { rm -rf "${work_dir}"; }
          trap cleanup EXIT

          cd "${work_dir}"

          echo "ä¸‹è½½æºç ..."
          curl -fsSL -L --retry 3 --retry-delay 10 \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/${UPSTREAM_REPO}/tarball/${version}" -o source.tar.gz

          echo "è§£å‹æºç ..."
          mkdir -p untar
          tar -xzf source.tar.gz -C untar --no-same-permissions

          extracted_path="$(find untar -mindepth 1 -maxdepth 1 -type d | head -n 1 || true)"
          if [ -z "${extracted_path}" ]; then
            echo "æœªæ‰¾åˆ°è§£å‹ç›®å½•"
            exit 1
          fi

          echo "åŸå§‹ç›®å½•: $(basename "${extracted_path}")"
          mv "${extracted_path}" "untar/${subdir}"

          echo "è·å– commit æ—¶é—´æˆ³..."
          commit_ts="$(curl -fsSL --retry 3 --retry-delay 10 \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/${UPSTREAM_REPO}/commits/${version}" | jq -r '.commit.committer.date // empty')"

          if [ -z "${commit_ts}" ]; then
            echo "æ— æ³•è·å– commit æ—¶é—´æˆ³"
            exit 1
          fi

          timestamp="$(date -d "${commit_ts}" +%s)"
          echo "Commit æ—¶é—´æˆ³: ${timestamp}"

          echo "é‡æ–°æ‰“åŒ…..."
          GZIP=-n tar --numeric-owner --owner=0 --group=0 --sort=name --mode=a-s \
              --mtime="@${timestamp}" \
              -C untar -czf "${subdir}.tar.gz" "${subdir}"

          hash="$(sha256sum "${subdir}.tar.gz" | cut -d ' ' -f 1)"
          echo "hash=${hash}" >> "${GITHUB_OUTPUT}"
          echo "æ–°ç‰ˆæœ¬ hash: ${hash}"

      - name: Update Makefile
        if: steps.meta.outputs.need_update == 'true'
        run: |
          set -euo pipefail

          makefile="${MAKEFILE_PATH}"
          version="${{ steps.meta.outputs.latest_version }}"
          pkg_version="${{ steps.meta.outputs.pkg_version }}"
          hash="${{ steps.hash.outputs.hash }}"

          sed -i -E "s/^([[:space:]]*PKG_VERSION:=).*/\\1${pkg_version}/" "${makefile}"
          sed -i -E "s/^([[:space:]]*PKG_SOURCE_VERSION:=).*/\\1${version}/" "${makefile}"
          sed -i -E "s/^([[:space:]]*PKG_MIRROR_HASH:=).*/\\1${hash}/" "${makefile}"

          echo "Makefile å·²æ›´æ–°:"
          grep -E "^[[:space:]]*(PKG_VERSION|PKG_SOURCE_VERSION|PKG_MIRROR_HASH):=" "${makefile}"

      - name: Commit and push changes
        if: steps.meta.outputs.need_update == 'true'
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${MAKEFILE_PATH}"

          if git diff --cached --quiet; then
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
            exit 0
          fi

          git commit -m "chore: update mihomo to ${{ steps.meta.outputs.latest_version }}"
          git push

      - name: Send Telegram Notification
        if: steps.meta.outputs.need_update == 'true' && env.TG_BOT_TOKEN != '' && env.TG_CHAT_ID != ''
        run: |
          set -euo pipefail

          old_ver="${{ steps.meta.outputs.current_version }}"
          new_ver="${{ steps.meta.outputs.latest_version }}"
          release_time="$(TZ='Asia/Shanghai' date -d "${{ steps.meta.outputs.published_at }}" '+%Y-%m-%d %H:%M:%S')"
          upstream_url="https://github.com/${UPSTREAM_REPO}/releases/tag/${new_ver}"
          repo_url="https://github.com/${{ github.repository }}"

          printf -v message '%s\n' \
            "ğŸš€ *Mihomo å†…æ ¸æ›´æ–°é€šçŸ¥*" \
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" \
            "ğŸ“¦ *ç‰ˆæœ¬å˜æ›´*" \
            "\`${old_ver}\` âœ \`${new_ver}\`" \
            "" \
            "ğŸ• *ä¸Šæ¸¸å‘å¸ƒæ—¶é—´*" \
            "${release_time} (åŒ—äº¬æ—¶é—´)" \
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" \
            "ğŸ”— [æŸ¥çœ‹ä¸Šæ¸¸ Release](${upstream_url})" \
            "ğŸ”— [æŸ¥çœ‹æœ¬ä»“åº“](${repo_url})" \
            "" \
            "âœ… Makefile å·²è‡ªåŠ¨åŒæ­¥æ›´æ–°"

          curl -fsSL -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg chat_id "${TG_CHAT_ID}" --arg text "${message}" \
              '{chat_id: $chat_id, text: $text, parse_mode: "Markdown", disable_web_page_preview: true}')" \
            && echo "Telegram é€šçŸ¥å‘é€æˆåŠŸ" || echo "Telegram é€šçŸ¥å‘é€å¤±è´¥"

      - name: Delete Workflow Runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 1
