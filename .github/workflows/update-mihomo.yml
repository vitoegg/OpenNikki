name: Update Mihomo

on:
  schedule:
    # 每天 北京时间 8:30 定时执行（UTC 00:30）
    - cron: '30 0 * * *'
  workflow_dispatch:
    # 支持手动触发

permissions:
  contents: write
  actions: write

concurrency:
  group: update-mihomo
  cancel-in-progress: false

jobs:
  update:
    name: Check and Update Mihomo
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      MAKEFILE_PATH: nikki/Makefile
      UPSTREAM_REPO: MetaCubeX/mihomo
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine versions
        id: meta
        run: |
          set -euo pipefail

          makefile="${MAKEFILE_PATH}"

          pkg_name="$(awk -F':=' '/^[[:space:]]*PKG_NAME:=/{print $2; exit}' "${makefile}" | tr -d ' \t\r\n')"
          current_version="$(awk -F':=' '/^[[:space:]]*PKG_SOURCE_VERSION:=/{print $2; exit}' "${makefile}" | tr -d ' \t\r\n')"

          if [ -z "${pkg_name}" ] || [ -z "${current_version}" ]; then
            echo "无法从 ${makefile} 读取 PKG_NAME 或 PKG_SOURCE_VERSION"
            exit 1
          fi

          echo "pkg_name=${pkg_name}" >> "${GITHUB_OUTPUT}"
          echo "current_version=${current_version}" >> "${GITHUB_OUTPUT}"
          echo "当前版本: ${current_version}"

          release_url="https://api.github.com/repos/${UPSTREAM_REPO}/releases/latest"
          echo "获取上游 release: ${release_url}"

          max_retries=3
          retry_delay=10
          release_info=""
          latest_version=""
          published_at=""

          for attempt in $(seq 1 "${max_retries}"); do
            echo "第 ${attempt}/${max_retries} 次尝试获取 release 信息..."

            if release_info="$(curl -fsSL -H "Authorization: Bearer ${GH_TOKEN}" "${release_url}" 2>/dev/null)"; then
              latest_version="$(echo "${release_info}" | jq -r '.tag_name // empty' 2>/dev/null || true)"
              published_at="$(echo "${release_info}" | jq -r '.published_at // empty' 2>/dev/null || true)"
              if [ -n "${latest_version}" ] && [ -n "${published_at}" ]; then
                break
              fi
            fi

            release_info=""
            latest_version=""
            published_at=""

            if [ "${attempt}" -lt "${max_retries}" ]; then
              echo "获取失败，${retry_delay} 秒后重试..."
              sleep "${retry_delay}"
            fi
          done

          if [ -z "${latest_version}" ] || [ -z "${published_at}" ]; then
            echo "skip=true" >> "${GITHUB_OUTPUT}"
            echo "need_update=false" >> "${GITHUB_OUTPUT}"
            echo "无法获取上游版本信息，跳过本次更新"
            if [ -n "${release_info}" ]; then
              echo "API 返回内容:"
              echo "${release_info}" | jq '.' 2>/dev/null || echo "${release_info}"
            fi
            exit 0
          fi

          pkg_version="$(date -d "${published_at}" +%Y.%m.%d)"

          echo "skip=false" >> "${GITHUB_OUTPUT}"
          echo "latest_version=${latest_version}" >> "${GITHUB_OUTPUT}"
          echo "pkg_version=${pkg_version}" >> "${GITHUB_OUTPUT}"
          echo "上游最新版本: ${latest_version}"
          echo "发布日期: ${pkg_version}"

          if [ "${current_version}" = "${latest_version}" ]; then
            echo "need_update=false" >> "${GITHUB_OUTPUT}"
            echo "版本相同，无需更新"
          else
            echo "need_update=true" >> "${GITHUB_OUTPUT}"
            echo "发现新版本，需要更新"
          fi

      - name: Calculate new hash (OpenWrt compatible)
        if: steps.meta.outputs.need_update == 'true'
        id: hash
        run: |
          set -euo pipefail

          version="${{ steps.meta.outputs.latest_version }}"
          pkg_name="${{ steps.meta.outputs.pkg_name }}"
          pkg_version="${{ steps.meta.outputs.pkg_version }}"
          subdir="${pkg_name}-${pkg_version}"

          echo "开始计算 hash..."
          echo "VERSION: ${version}"
          echo "PKG_VERSION: ${pkg_version}"
          echo "SUBDIR: ${subdir}"

          work_dir="$(mktemp -d)"
          cleanup() { rm -rf "${work_dir}"; }
          trap cleanup EXIT

          cd "${work_dir}"

          echo "下载源码..."
          curl -fsSL -L --retry 3 --retry-delay 10 \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/${UPSTREAM_REPO}/tarball/${version}" -o source.tar.gz

          echo "解压源码..."
          mkdir -p untar
          tar -xzf source.tar.gz -C untar --no-same-permissions

          extracted_path="$(find untar -mindepth 1 -maxdepth 1 -type d | head -n 1 || true)"
          if [ -z "${extracted_path}" ]; then
            echo "未找到解压目录"
            exit 1
          fi

          echo "原始目录: $(basename "${extracted_path}")"
          mv "${extracted_path}" "untar/${subdir}"

          echo "获取 commit 时间戳..."
          commit_ts="$(curl -fsSL --retry 3 --retry-delay 10 \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            "https://api.github.com/repos/${UPSTREAM_REPO}/commits/${version}" | jq -r '.commit.committer.date // empty')"

          if [ -z "${commit_ts}" ]; then
            echo "无法获取 commit 时间戳"
            exit 1
          fi

          timestamp="$(date -d "${commit_ts}" +%s)"
          echo "Commit 时间戳: ${timestamp}"

          echo "重新打包..."
          GZIP=-n tar --numeric-owner --owner=0 --group=0 --sort=name --mode=a-s \
              --mtime="@${timestamp}" \
              -C untar -czf "${subdir}.tar.gz" "${subdir}"

          hash="$(sha256sum "${subdir}.tar.gz" | cut -d ' ' -f 1)"
          echo "hash=${hash}" >> "${GITHUB_OUTPUT}"
          echo "新版本 hash: ${hash}"

      - name: Update Makefile
        if: steps.meta.outputs.need_update == 'true'
        run: |
          set -euo pipefail

          makefile="${MAKEFILE_PATH}"
          version="${{ steps.meta.outputs.latest_version }}"
          pkg_version="${{ steps.meta.outputs.pkg_version }}"
          hash="${{ steps.hash.outputs.hash }}"

          sed -i -E "s/^([[:space:]]*PKG_VERSION:=).*/\\1${pkg_version}/" "${makefile}"
          sed -i -E "s/^([[:space:]]*PKG_SOURCE_VERSION:=).*/\\1${version}/" "${makefile}"
          sed -i -E "s/^([[:space:]]*PKG_MIRROR_HASH:=).*/\\1${hash}/" "${makefile}"

          echo "Makefile 已更新:"
          grep -E "^[[:space:]]*(PKG_VERSION|PKG_SOURCE_VERSION|PKG_MIRROR_HASH):=" "${makefile}"

      - name: Commit and push changes
        if: steps.meta.outputs.need_update == 'true'
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${MAKEFILE_PATH}"

          if git diff --cached --quiet; then
            echo "没有需要提交的变更"
            exit 0
          fi

          git commit -m "chore: update mihomo to ${{ steps.meta.outputs.latest_version }}"
          git push

      - name: Delete Workflow Runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 1
