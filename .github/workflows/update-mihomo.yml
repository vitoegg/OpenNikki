name: Update Mihomo

on:
  schedule:
    # 每天 UTC 时间 0:00 运行（北京时间 8:00）
    - cron: '0 0 * * *'
  workflow_dispatch:
    # 支持手动触发

permissions:
  contents: write
  actions: write

jobs:
  update:
    name: Check and Update Mihomo
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current version
        id: current
        run: |
          # 从 Makefile 中提取当前版本
          CURRENT_VERSION=$(grep -oP 'PKG_SOURCE_VERSION:=\K.*' nikki/Makefile)
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "当前版本: $CURRENT_VERSION"

      - name: Get latest release from upstream
        id: upstream
        run: |
          # 获取 MetaCubeX/mihomo 最新 release 信息
          RELEASE_INFO=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest)
          
          # 获取版本号（tag）
          LATEST_VERSION=$(echo "$RELEASE_INFO" | jq -r '.tag_name')
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "上游最新版本: $LATEST_VERSION"
          
          # 获取发布日期并格式化为 YYYY.MM.DD
          PUBLISHED_AT=$(echo "$RELEASE_INFO" | jq -r '.published_at')
          PKG_VERSION=$(date -d "$PUBLISHED_AT" +%Y.%m.%d)
          echo "pkg_version=$PKG_VERSION" >> $GITHUB_OUTPUT
          echo "发布日期: $PKG_VERSION"

      - name: Compare versions
        id: compare
        run: |
          if [ "${{ steps.current.outputs.version }}" = "${{ steps.upstream.outputs.version }}" ]; then
            echo "版本相同，无需更新"
            echo "need_update=false" >> $GITHUB_OUTPUT
          else
            echo "发现新版本，需要更新"
            echo "need_update=true" >> $GITHUB_OUTPUT
          fi

      - name: Calculate new hash (OpenWrt compatible)
        if: steps.compare.outputs.need_update == 'true'
        id: hash
        run: |
          VERSION="${{ steps.upstream.outputs.version }}"
          PKG_NAME="nikki"
          # 使用新的 PKG_VERSION（release 发布日期）
          PKG_VERSION="${{ steps.upstream.outputs.pkg_version }}"
          SUBDIR="${PKG_NAME}-${PKG_VERSION}"
          
          echo "开始计算 hash..."
          echo "VERSION: $VERSION"
          echo "PKG_VERSION: $PKG_VERSION"
          echo "SUBDIR: $SUBDIR"
          
          # 创建临时目录
          WORK_DIR=$(mktemp -d)
          cd "$WORK_DIR"
          
          # 1. 使用 GitHub tarball API 下载（与 OpenWrt 相同）
          echo "下载源码..."
          curl -sL "https://api.github.com/repos/MetaCubeX/mihomo/tarball/${VERSION}" -o source.tar.gz
          
          # 2. 解压
          echo "解压源码..."
          mkdir untar
          tar -xzf source.tar.gz -C untar --no-same-permissions
          
          # 3. 获取解压后的目录名并重命名
          EXTRACTED_DIR=$(ls untar)
          echo "原始目录: $EXTRACTED_DIR"
          mv "untar/$EXTRACTED_DIR" "untar/$SUBDIR"
          
          # 4. 获取 commit 时间戳（用于可重复构建）
          echo "获取 commit 时间戳..."
          COMMIT_TS=$(curl -s "https://api.github.com/repos/MetaCubeX/mihomo/commits/${VERSION}" | jq -r '.commit.committer.date')
          TIMESTAMP=$(date -d "$COMMIT_TS" +%s)
          echo "Commit 时间戳: $TIMESTAMP"
          
          # 5. 重新打包（使用与 OpenWrt 相同的参数）
          echo "重新打包..."
          # GZIP=-n 确保 gzip 不存储文件名和时间戳，保证可重复构建
          GZIP=-n tar --numeric-owner --owner=0 --group=0 --sort=name --mode=a-s \
              --mtime="@${TIMESTAMP}" \
              -C untar -czf "${SUBDIR}.tar.gz" "$SUBDIR"
          
          # 6. 计算 SHA256 hash
          HASH=$(sha256sum "${SUBDIR}.tar.gz" | cut -d ' ' -f 1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "新版本 hash: $HASH"
          
          # 清理
          cd -
          rm -rf "$WORK_DIR"

      - name: Update Makefile
        if: steps.compare.outputs.need_update == 'true'
        run: |
          VERSION="${{ steps.upstream.outputs.version }}"
          PKG_VERSION="${{ steps.upstream.outputs.pkg_version }}"
          HASH="${{ steps.hash.outputs.hash }}"
          
          # 更新 PKG_VERSION（release 发布日期）
          sed -i "s/PKG_VERSION:=.*/PKG_VERSION:=${PKG_VERSION}/" nikki/Makefile
          # 更新 PKG_SOURCE_VERSION（git tag）
          sed -i "s/PKG_SOURCE_VERSION:=.*/PKG_SOURCE_VERSION:=${VERSION}/" nikki/Makefile
          # 更新哈希值
          sed -i "s/PKG_MIRROR_HASH:=.*/PKG_MIRROR_HASH:=${HASH}/" nikki/Makefile
          
          echo "Makefile 已更新:"
          grep -E "PKG_VERSION|PKG_SOURCE_VERSION|PKG_MIRROR_HASH" nikki/Makefile

      - name: Commit and push changes
        if: steps.compare.outputs.need_update == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add nikki/Makefile
          git commit -m "chore: update mihomo to ${{ steps.upstream.outputs.version }}"
          git push

      - name: Delete Workflow Runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 1